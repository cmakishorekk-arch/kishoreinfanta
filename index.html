<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Our Memories ‚Äî White & Blue (Local + GitHub)</title>
<meta name="description" content="Romantic white & blue gallery with continuous file names, local & GitHub-ready."/>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f7fbff; --ink:#0c385f; --muted:#5d7a98; --card:#ffffff; --line:#dbeafe;
  --accent:#2f80ff; --heart:#ff3b6b; --shadow:0 10px 30px rgba(12,56,95,.08);
}
*{box-sizing:border-box}
body{
  margin:0; font-family:"Poppins",system-ui,Segoe UI,Roboto,Arial,sans-serif; color:var(--ink);
  background:radial-gradient(1000px 600px at 80% -10%, #eaf4ff 0%, var(--bg) 60%, #fff 100%);
  min-height:100vh; display:flex; flex-direction:column; overflow-x:hidden;
}
.wrap{width:min(1200px,94vw); margin:0 auto;}
a,button,input{ -webkit-tap-highlight-color:transparent; }

/* Cover */
.cover{position:relative; border-bottom:1px solid var(--line); background:linear-gradient(180deg,#eaf4ff,transparent);}
.cover .inner{padding:18px 12px 10px; position:relative;}
.coverPic{
  width:100%;
  height:clamp(260px, 38vw, 420px);
  border-radius:18px; object-fit:cover; display:block;
  background:linear-gradient(120deg,#eaf2ff,#ffffff); border:1px solid var(--line); box-shadow:var(--shadow);
}
.brand{position:absolute; left:24px; bottom:22px; background:rgba(255,255,255,.92); border:1px solid var(--line); border-radius:14px; padding:10px 14px; box-shadow:var(--shadow);}
.brand h1{margin:0; font-size:clamp(18px,3vw,26px);}
.brand .love{color:var(--heart); font-weight:900; animation: beat 1.1s ease-in-out infinite; margin:0 6px;}
@keyframes beat{0%,100%{transform:scale(1)} 50%{transform:scale(1.15)}}

/* Hearts on cover */
.coverFX{position:absolute; inset:0; border-radius:18px; pointer-events:none; overflow:hidden; z-index:2;}
.hearts{position:absolute; inset:0; overflow:hidden;}
.hWrap{position:absolute; bottom:-30px; left:0; animation: sway 3.6s ease-in-out infinite alternate;}
.heart{font-size:22px; color:var(--heart); text-shadow:0 4px 10px rgba(255,59,107,.35); animation: floatUp 11s linear forwards;}
@keyframes floatUp{from{transform:translateY(0)} to{transform:translateY(-130%)}}
@keyframes sway{from{transform:translateX(-8px)} to{transform:translateX(8px)}}

/* Full-height side balloons */
.sideBalloons{position:fixed; top:0; bottom:0; width:clamp(52px, 8vw, 100px); pointer-events:none; z-index:3;}
.sideBalloons.left{left:0;}
.sideBalloons.right{right:0;}
.bWrap{position:absolute; bottom:-120px; left:8px; animation: sway 3.2s ease-in-out infinite alternate;}
.balloonImg{width:78px; filter: drop-shadow(0 12px 18px rgba(15,40,70,.25)); animation: riseLong 18s linear forwards;}
@keyframes riseLong{from{transform:translateY(0)} to{transform:translateY(-200%)}}

/* Music dock (top-right, below cover) */
.musicDock{
  position:fixed; right:16px; top:16px; z-index:35;
  width:min(320px, 92vw);
  background:linear-gradient(180deg,#101928,#0a111c); color:#e9f1ff;
  border:1px solid #1f2e46; border-radius:16px; box-shadow:0 16px 28px rgba(8,14,24,.55);
}
.musicDock .controls{display:flex; gap:8px; padding:10px; border-bottom:1px solid #1f2e46; position:sticky; top:0; background:inherit; border-radius:16px 16px 0 0;}
.musicDock .btn{background:#1a2a44; color:#e9f1ff; border:1px solid #2c436a; border-radius:10px; padding:8px 10px; cursor:pointer; min-width:40px;}
.musicDock .btn.play{background:#e9f1ff; color:#0a111c; font-weight:900;}
.musicDock .list{max-height:50vh; overflow:auto; padding:6px;}
.musicDock ul{list-style:none; margin:0; padding:0;}
.musicDock li{display:flex; align-items:center; gap:10px; padding:8px 10px; border-bottom:1px solid rgba(255,255,255,.06); cursor:pointer;}
.musicDock li:hover{background:#122036;}
.musicDock li.active{background:#2a3a58;}
.musicDock .num{font-weight:800; color:#a8c4ff; min-width:34px; text-align:right;}
.musicDock .title{flex:1 1 auto; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}

/* Group overview */
.groups{padding:18px 0 8px;}
.grid-cards{display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:16px;}
.card{background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow);}
.group-card{padding:10px;}
.group-head{display:flex; align-items:center; justify-content:space-between; gap:8px; margin:6px 2px 10px;}
.group-title{font-weight:800;}
.badge-count{font-size:.85rem; color:var(--muted);}
.mini-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:6px; border-radius:12px; overflow:hidden;}
.mini-grid img{width:100%; height:100%; aspect-ratio:1/1; object-fit:cover; display:block; background:#f3f7ff;}
.group-card button.open{width:100%; margin-top:10px; background:var(--accent); color:#fff; border:none; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer;}

/* Modal */
.modal{position:fixed; inset:0; display:none; background:rgba(4,12,20,.7); z-index:40; align-items:center; justify-content:center; padding:20px;}
.modal.open{display:flex;}
.modal .panel{background:#fff; border-radius:16px; width:min(1100px,94vw); max-height:92vh; overflow:auto; padding:14px; position:relative; border:1px solid var(--line);}
.modal .panel h3{margin:0 0 10px 0;}
.modal .panel .closeX{position:absolute; right:14px; top:12px;}

/* Full grid */
.full-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:10px;}
.full-grid img{width:100%; height:100%; object-fit:cover; aspect-ratio:1/1; display:block; border-radius:10px; background:#f3f7ff; cursor:pointer;}

/* Lightbox */
.lightbox{position:fixed; inset:0; display:none; background:rgba(6,12,20,.92); z-index:60; align-items:center; justify-content:center;}
.lightbox.open{display:flex;}
.lbWrap{max-width:94vw; max-height:92vh;}
.lbImg{max-width:94vw; max-height:92vh; border-radius:12px; box-shadow:0 10px 40px rgba(3,18,31,.6);}
.navBtn{position:fixed; top:50%; transform:translateY(-50%); background:#fff; border:1px solid var(--line); border-radius:12px; padding:8px 12px; cursor:pointer; font-weight:800;}
.navPrev{left:18px} .navNext{right:18px} .navClose{top:16px; right:16px; transform:none;}

/* Letter viewer (zoom + pan) */
.letterModal{position:fixed; inset:0; display:none; background:rgba(0,0,0,.85); z-index:70; align-items:center; justify-content:center; padding:20px;}
.letterModal.open{display:flex;}
.letterViewer{position:relative; background:#0a111c; border:1px solid #1f2e46; border-radius:14px; width:min(1000px, 94vw); height:min(90vh, 1000px); overflow:hidden; box-shadow:0 16px 60px rgba(8,14,24,.6);}
.lToolbar{position:absolute; top:10px; right:10px; display:flex; gap:8px; z-index:2;}
.lToolbar .btn{background:#1a2a44; color:#e9f1ff; border:1px solid #2c436a; border-radius:10px; padding:8px 10px; cursor:pointer;}
.lCanvas{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; overflow:hidden; cursor:grab;}
.lCanvas.grabbing{cursor:grabbing;}
.lImg{will-change:transform; max-width:none; max-height:none; border-radius:10px; box-shadow:0 12px 28px rgba(0,0,0,.45);}

/* QR */
.qr{position:fixed; left:16px; bottom:16px; z-index:50; display:none; align-items:center; gap:8px; background:rgba(255,255,255,.9); border:1px solid var(--line); padding:8px 10px; border-radius:12px; box-shadow:var(--shadow);}
.qr img{width:72px; height:72px; object-fit:contain; border-radius:8px;}
.qr .lbl{font-weight:800; color:var(--ink);}

footer{text-align:center; padding:30px 0 80px; color:var(--muted);}
</style>
</head>
<body>

<!-- Full-height side balloons (left/right) -->
<div class="sideBalloons left" id="sideLeft" aria-hidden="true"></div>
<div class="sideBalloons right" id="sideRight" aria-hidden="true"></div>

<div class="cover">
  <div class="wrap inner">
    <img id="coverPic" class="coverPic" alt="Cover"/>
    <!-- Cover FX: hearts overlay -->
    <div class="coverFX" aria-hidden="true">
      <div class="hearts" id="coverHearts"></div>
    </div>
    <div class="brand">
      <h1><strong>Kishore</strong><span class="love">‚ù§</span>&nbsp;<strong>Ashwin Infanta</strong></h1>
    </div>
  </div>
</div>

<!-- Music Dock (top-right, will reposition below cover via JS) -->
<aside class="musicDock" id="musicDock" aria-label="Music player">
  <div class="controls">
    <button class="btn" id="mShuffle" title="Shuffle">üîÄ</button>
    <button class="btn" id="mPrev" title="Prev">‚èÆ</button>
    <button class="btn play" id="mPlay" title="Play/Pause">‚ñ∂</button>
    <button class="btn" id="mNext" title="Next">‚è≠</button>
    <button class="btn" id="mRepeat" title="Repeat">üîÅ</button>
  </div>
  <div class="list">
    <ul id="songItems"></ul>
  </div>
</aside>

<main class="wrap groups">
  <section class="grid-cards" id="groupCards"></section>
</main>

<!-- Group modal (full grid) -->
<div class="modal" id="groupModal" aria-hidden="true">
  <div class="panel">
    <button class="closeX" id="gmClose">Close ‚úï</button>
    <h3 id="gmTitle">Group</h3>
    <div class="full-grid" id="gmGrid"></div>
  </div>
</div>

<!-- Lightbox -->
<div class="lightbox" id="lightbox" aria-hidden="true">
  <div class="lbWrap">
    <img id="lbImg" class="lbImg" alt="Large view"/>
  </div>
  <button class="navBtn navPrev" id="navPrev">‚óÄ</button>
  <button class="navBtn navNext" id="navNext">‚ñ∂</button>
  <button class="navBtn navClose" id="navClose">‚úï</button>
</div>

<!-- Letter Viewer (zoomable) -->
<div class="letterModal" id="letterModal" aria-hidden="true">
  <div class="letterViewer">
    <div class="lToolbar">
      <button class="btn" id="ltZoomIn" title="Zoom in">Ôºã</button>
      <button class="btn" id="ltZoomOut" title="Zoom out">Ôºç</button>
      <button class="btn" id="ltReset" title="Reset">‚ü≤</button>
      <button class="btn" id="ltPrev" title="Previous">‚óÄ</button>
      <button class="btn" id="ltNext" title="Next">‚ñ∂</button>
      <button class="btn" id="ltClose" title="Close">‚úï</button>
    </div>
    <div class="lCanvas" id="lCanvas">
      <img id="letterImg" class="lImg" alt="Letter"/>
    </div>
  </div>
</div>

<!-- Open letter button -->
<button class="btn" id="openLetter" style="position:fixed; right:16px; bottom:16px; z-index:45; background:#ff3b6b; color:#fff; border:none; border-radius:999px; padding:12px 18px; box-shadow:0 10px 22px rgba(255,59,107,.45);">Open Letter ‚úâÔ∏è</button>

<!-- Optional QR -->
<div class="qr" id="qrBox">
  <img id="qrImg" alt="INFANTA QR"/>
  <div class="lbl">INFANTA</div>
</div>

<footer>¬© 2025 ‚Äî White & Blue, with all my love</footer>

<script>
// ===== Helpers =====
const IMG_EXTS = ['jpg','jpeg','png','webp','svg'];
const SONG_EXTS = ['mp3','m4a','ogg','wav','mp4']; // MP4 support added
function pad3(n){ return String(n).padStart(3,'0'); }

function imgExists(url){
  return new Promise(resolve=>{
    const im = new Image();
    im.onload = ()=> resolve(true);
    im.onerror = ()=> resolve(false);
    im.src = url + '?v=' + Date.now();
  });
}
async function fileExists(url){
  try{
    const r = await fetch(url + '?v=' + Date.now(), { method:'HEAD', cache:'no-store' });
    return r.ok;
  }catch(e){ return false; }
}
async function fetchTextSafe(url){
  try{
    const r = await fetch(url + '?v=' + Date.now(), { cache:'no-store' });
    if(!r.ok) return null;
    const t = (await r.text()).trim();
    return t || null;
  }catch(e){ return null; }
}
async function findFirstExisting(urls, check='img'){
  for (const u of urls){
    const ok = (check==='img') ? await imgExists(u) : await fileExists(u);
    if(ok) return u;
  }
  return null;
}
async function loadSequence(base, stem, exts, start=1, max=999, allowGaps=false, check='img'){
  const out=[]; let misses=0;
  for (let i=start;i<=max;i++){
    const num = pad3(i);
    const cands = exts.map(ext => base + stem.replace('{num}', num) + '.' + ext);
    const found = await findFirstExisting(cands, check);
    if(found){ out.push(found); misses=0; } else { misses++; if(!allowGaps && misses>=3) break; }
  }
  return out;
}

// ===== Cover photo =====
(async function coverDetect(){
  const cover = document.getElementById('coverPic');
  const found = await findFirstExisting(['cover/cover.jpg','cover/cover.jpeg','cover/cover.png','cover/cover.webp']);
  cover.src = found || 'data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns=\\"http://www.w3.org/2000/svg\\" width=\\"1600\\" height=\\"600\\"><defs><linearGradient id=\\"g\\" x1=\\"0\\" y1=\\"0\\" x2=\\"1\\" y2=\\"1\\"><stop offset=\\"0\\" stop-color=\\"#eaf2ff\\"/><stop offset=\\"1\\" stop-color=\\"#ffffff\\"/></linearGradient></defs><rect width=\\"100%\\" height=\\"100%\\" fill=\\"url(#g)\\"/></svg>');
})();

// ===== Hearts on cover =====
(function heartsFX(){
  const box = document.getElementById('coverHearts');
  function spawn(){
    const wrap = document.createElement('div');
    wrap.className = 'hWrap';
    wrap.style.left = (Math.random()*100) + '%';
    wrap.style.animationDuration = (3 + Math.random()*3) + 's';

    const h = document.createElement('div');
    h.className = 'heart';
    h.textContent = '‚ù§';
    h.style.fontSize = (16 + Math.random()*24) + 'px';
    h.style.opacity = 0.75 + Math.random()*0.25;
    h.style.animationDuration = (8 + Math.random()*7) + 's';

    wrap.appendChild(h);
    box.appendChild(wrap);
    setTimeout(()=> wrap.remove(), 16000);
  }
  for (let i=0;i<12;i++) setTimeout(spawn, i*350);
  setInterval(spawn, 900);
})();

// ===== Full-height side balloons =====
(async function sideBalloons(){
  const leftBox = document.getElementById('sideLeft');
  const rightBox = document.getElementById('sideRight');
  const balloons = await loadSequence('balloons/','balloon-{num}',['png','webp','jpg','jpeg'],1,120,true,'img');
  const fallbackEmoji = !balloons.length;

  function spawnOne(box){
    const wrap = document.createElement('div');
    wrap.className = 'bWrap';
    const laneWidth = box.getBoundingClientRect().width || 80;
    const offset = Math.random() * (laneWidth - 40);
    wrap.style.left = Math.max(6, offset) + 'px';
    wrap.style.animationDuration = (2.8 + Math.random()*1.4) + 's';

    if(fallbackEmoji){
      const e = document.createElement('div');
      e.textContent = 'üéà';
      e.style.fontSize = (28 + Math.random()*16) + 'px';
      e.style.filter = 'drop-shadow(0 12px 18px rgba(15,40,70,.25))';
      e.style.animation = 'riseLong ' + (16 + Math.random()*8) + 's linear forwards';
      wrap.appendChild(e);
    }else{
      const img = document.createElement('img');
      img.className = 'balloonImg';
      img.src = balloons[Math.floor(Math.random()*balloons.length)];
      img.style.width = (60 + Math.random()*26) + 'px';
      img.style.animationDuration = (16 + Math.random()*8) + 's';
      wrap.appendChild(img);
    }

    box.appendChild(wrap);
    setTimeout(()=> wrap.remove(), 26000);
  }

  for(let i=0;i<6;i++){
    setTimeout(()=> spawnOne(leftBox), i*450);
    setTimeout(()=> spawnOne(rightBox), i*450 + 220);
  }
  setInterval(()=> spawnOne(leftBox), 1100);
  setInterval(()=> spawnOne(rightBox), 1100);
})();

// ===== Music dock (discovery + list) =====
const mShuffle = document.getElementById('mShuffle');
const mPrev = document.getElementById('mPrev');
const mPlay = document.getElementById('mPlay');
const mNext = document.getElementById('mNext');
const mRepeat = document.getElementById('mRepeat');
const musicDock = document.getElementById('musicDock');
const songItems = document.getElementById('songItems');
const audio = new Audio();
let songs=[]; let titles=[]; let sidx=0; let shuffle=false;

function basename(path){ return path.split('/').pop(); }
function deriveTitleFromFilename(fn){
  const m = fn.match(/song-(\d+)/i);
  if(m) return 'Song ' + m[1];
  return fn.replace(/\.[^.]+$/,'').replace(/[-_]+/g,' ').trim();
}

// Position dock below cover (not overlapping)
function placeDock(){
  const cover = document.getElementById('coverPic');
  const rect = cover.getBoundingClientRect();
  const top = rect.height + 16; // 16px below cover
  musicDock.style.top = top + 'px';
}
window.addEventListener('load', placeDock);
window.addEventListener('resize', placeDock);

// Discover songs & titles
async function fetchTextSafe(url){
  try{
    const r = await fetch(url + '?v=' + Date.now(), { cache:'no-store' });
    if(!r.ok) return null;
    const t = (await r.text()).trim();
    return t || null;
  }catch(e){ return null; }
}
async function findFirstExisting(urls, check='img'){
  for (const u of urls){
    try{
      const r = await fetch(u + '?v=' + Date.now(), { method:'HEAD', cache:'no-store' });
      if(r.ok) return u;
    }catch(e){}
  }
  return null;
}
async function loadSequence(base, stem, exts, start=1, max=999, allowGaps=false, check='img'){
  const out=[]; let misses=0;
  for (let i=start;i<=max;i++){
    const num = String(i).padStart(3,'0');
    const cands = exts.map(ext => base + stem.replace('{num}', num) + '.' + ext);
    const found = await findFirstExisting(cands, check);
    if(found){ out.push(found); misses=0; } else { misses++; if(!allowGaps && misses>=3) break; }
  }
  return out;
}
(async function loadSongs(){
  const exts = ['mp3','m4a','ogg','wav','mp4'];
  const found = await loadSequence('songs/','song-{num}',exts,1,999,false,'file');
  found.sort((a,b)=>{
    const na = parseInt((a.match(/song-(\d+)\./)||['','0'])[1],10);
    const nb = parseInt((b.match(/song-(\d+)\./)||['','0'])[1],10);
    return na-nb;
  });
  songs = found;
  titles = await Promise.all(songs.map(async (url)=>{
    const num = (url.match(/song-(\d+)\./)||['',''])[1];
    const sidecar = num ? await fetchTextSafe(`songs/song-${num}.txt`) : null;
    return sidecar || deriveTitleFromFilename(basename(url));
  }));
  renderSongList();
  mPlay.textContent = '‚ñ∂';
})();

function renderSongList(){
  songItems.innerHTML = songs.map((_,i)=>`<li data-i="${i}"><div class="num">${String(i+1).padStart(2,'0')}</div><div class="title">${titles[i]}</div></li>`).join('');
  songItems.querySelectorAll('li').forEach(li=>{
    li.addEventListener('click', ()=>{ playAt(parseInt(li.dataset.i,10)); highlightActive(); });
  });
  highlightActive();
}
function highlightActive(){
  songItems.querySelectorAll('li').forEach((li,i)=>{
    li.classList.toggle('active', i===sidx && !audio.paused);
  });
}
function playAt(i){
  if(!songs.length) return;
  sidx = (i + songs.length) % songs.length;
  audio.src = songs[sidx];
  audio.play().catch(()=>{ mPlay.textContent='‚ñ∂'; });
}

mPlay.addEventListener('click', ()=>{
  if(!songs.length) return;
  if(audio.src==='') playAt(0);
  else if(audio.paused){ audio.play().catch(()=>{}); } else { audio.pause(); }
});
mPrev.addEventListener('click', ()=> playAt(sidx-1));
mNext.addEventListener('click', ()=> playAt(shuffle ? Math.floor(Math.random()*songs.length) : sidx+1));
mShuffle.addEventListener('click', ()=>{ shuffle=!shuffle; mShuffle.style.background = shuffle ? '#2b3f61' : '#1a2a44'; });
mRepeat.addEventListener('click', ()=>{ audio.loop = !audio.loop; mRepeat.style.background = audio.loop ? '#2b3f61' : '#1a2a44'; });
audio.addEventListener('play', ()=>{ mPlay.textContent='‚è∏'; highlightActive(); });
audio.addEventListener('pause', ()=>{ mPlay.textContent='‚ñ∂'; highlightActive(); });

// ===== Galleries (includes Temple Date) =====
const GROUPS = [
  {label:'üì∏ Portrait', slug:'portrait'},
  {label:'‚òï Coffedate', slug:'coffedate'},
  {label:'üéÇ Birthday', slug:'birthday'},
  {label:'üåô Nightout', slug:'nightout'},
  {label:'üé® Painting Date', slug:'painting-date'},
  {label:'üõï Temple Date', slug:'temple-date'},
  {label:'üíñ My Favourite', slug:'my-favourite'}
];

const groupCards = document.getElementById('groupCards');

async function buildCards(){
  const cards=[];
  for(const g of GROUPS){
    const images = await loadSequence(g.slug + '/', '{num}', ['jpg','jpeg','png','webp'], 1, 999, false, 'img');
    const thumbs = images.slice(0,4);
    const grid = thumbs.map(t=>`<img src="${t}" alt="">`).join('') || `<div style="grid-column:1/-1; text-align:center; padding:20px; color:#9aa6b6;">Add photos to <b>${g.slug}/</b> as 001.jpg, 002.jpg ‚Ä¶</div>`;
    cards.push(`
      <article class="card group-card" data-slug="${g.slug}" data-label="${g.label}">
        <div class="group-head">
          <div class="group-title">${g.label}</div>
          <div class="badge-count">${images.length} photo(s)</div>
        </div>
        <div class="mini-grid">${grid}</div>
        <button class="open">Open</button>
      </article>`);
  }
  groupCards.innerHTML = cards.join('');
  groupCards.querySelectorAll('.group-card .open').forEach(btn=>{
    btn.addEventListener('click',(e)=>{
      const card = e.currentTarget.closest('.group-card');
      openGroup(card.dataset.slug, card.dataset.label);
    });
  });
}
buildCards();

// ===== Group modal + Lightbox =====
const groupModal = document.getElementById('groupModal');
const gmClose = document.getElementById('gmClose');
const gmTitle = document.getElementById('gmTitle');
const gmGrid = document.getElementById('gmGrid');
const lb = document.getElementById('lightbox');
const lbImg = document.getElementById('lbImg');
const navPrev = document.getElementById('navPrev');
const navNext = document.getElementById('navNext');
const navClose = document.getElementById('navClose');
let items=[]; let idx=0;

function openLightbox(i){ idx=i; lb.classList.add('open'); lb.setAttribute('aria-hidden','false'); lbImg.src = items[idx]; }
function move(d){ idx = (idx + d + items.length) % items.length; lbImg.src = items[idx]; }
function closeLB(){ lb.classList.remove('open'); lb.setAttribute('aria-hidden','true'); lbImg.src=''; }
navPrev.addEventListener('click', ()=> move(-1));
navNext.addEventListener('click', ()=> move(1));
navClose.addEventListener('click', closeLB);
lb.addEventListener('click', e=>{ if(e.target===lb) closeLB(); });
window.addEventListener('keydown', e=>{ if(!lb.classList.contains('open')) return; if(e.key==='Escape') closeLB(); if(e.key==='ArrowRight') move(1); if(e.key==='ArrowLeft') move(-1); });

async function openGroup(slug, label){
  const images = await loadSequence(slug + '/', '{num}', ['jpg','jpeg','png','webp'], 1, 999, false, 'img');
  items = images;
  gmTitle.textContent = label + ' ‚Äî ' + images.length + ' photo(s)';
  gmGrid.innerHTML = images.map((src,i)=> `<img data-i="${i}" src="${src}" alt="photo">`).join('');
  gmGrid.querySelectorAll('img').forEach(el => el.addEventListener('click', e => openLightbox(parseInt(e.currentTarget.dataset.i,10))));
  groupModal.classList.add('open'); groupModal.setAttribute('aria-hidden','false');
}
gmClose.addEventListener('click', ()=> { groupModal.classList.remove('open'); groupModal.setAttribute('aria-hidden','true'); });

// ===== Letter viewer (zoom + drag) =====
const openLetterBtn = document.getElementById('openLetter');
const letterModal = document.getElementById('letterModal');
const letterImg = document.getElementById('letterImg');
const lCanvas = document.getElementById('lCanvas');
const ltPrev = document.getElementById('ltPrev');
const ltNext = document.getElementById('ltNext');
const ltClose = document.getElementById('ltClose');
const ltZoomIn = document.getElementById('ltZoomIn');
const ltZoomOut = document.getElementById('ltZoomOut');
const ltReset = document.getElementById('ltReset');
let letters=[]; let lidx=0; let scale=1; let tx=0; let ty=0; let dragging=false; let lastX=0; let lastY=0;

function applyTransform(){ letterImg.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`; }
function fitToScreen(){ scale = 1; tx = 0; ty = 0; applyTransform(); }
function showLetter(i){
  if(!letters.length) return;
  lidx=(i+letters.length)%letters.length;
  letterImg.onload = ()=> { fitToScreen(); };
  letterImg.src=letters[lidx];
}
openLetterBtn.addEventListener('click', ()=>{ letterModal.classList.add('open'); letterModal.setAttribute('aria-hidden','false'); });
ltClose.addEventListener('click', ()=>{ letterModal.classList.remove('open'); letterModal.setAttribute('aria-hidden','true'); });

ltPrev.addEventListener('click', ()=> showLetter(lidx-1));
ltNext.addEventListener('click', ()=> showLetter(lidx+1));
ltZoomIn.addEventListener('click', ()=>{ scale = Math.min(6, scale*1.25); applyTransform(); });
ltZoomOut.addEventListener('click', ()=>{ scale = Math.max(0.2, scale/1.25); applyTransform(); });
ltReset.addEventListener('click', ()=> fitToScreen());

lCanvas.addEventListener('pointerdown', (e)=>{ dragging=true; lastX=e.clientX; lastY=e.clientY; lCanvas.classList.add('grabbing'); e.preventDefault(); });
lCanvas.addEventListener('pointermove', (e)=>{
  if(!dragging) return;
  tx += (e.clientX-lastX); ty += (e.clientY-lastY);
  lastX=e.clientX; lastY=e.clientY; applyTransform();
});
window.addEventListener('pointerup', ()=>{ dragging=false; lCanvas.classList.remove('grabbing'); });
lCanvas.addEventListener('wheel', (e)=>{
  e.preventDefault();
  const delta = e.deltaY<0 ? 1.1 : 0.9;
  scale = Math.min(6, Math.max(0.2, scale*delta));
  applyTransform();
},{passive:false});

(async function loadLetters(){
  const out=[]; let misses=0;
  for (let i=1;i<=999;i++){
    const num = String(i).padStart(3,'0');
    const cands = ['jpg','jpeg','png','webp'].map(ext=> `letters/letter-${num}.${ext}`);
    let hit=null;
    for(const u of cands){
      try{ const r=await fetch(u+'?v='+Date.now(), {method:'HEAD', cache:'no-store'}); if(r.ok){ hit=u; break; } }catch(e){}
    }
    if(hit){ out.push(hit); misses=0; } else { misses++; if(misses>=3) break; }
  }
  letters = out;
  if(letters.length) showLetter(0);
})();

// ===== Optional QR (qr/infanta.*) =====
(async function showQR(){
  const box = document.getElementById('qrBox');
  const img = document.getElementById('qrImg');
  const cands = ['qr/infanta.png','qr/infanta.jpg','qr/infanta.webp','qr/infanta.svg'];
  for(const u of cands){
    try{ const r=await fetch(u+'?v='+Date.now(), {method:'HEAD', cache:'no-store'}); if(r.ok){ img.src=u; box.style.display='flex'; break; } }catch(e){}
  }
})();
</script>
</body>
</html>
